<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸­å›½è‰²çš„è¯—æ„ï½œå¾®è¯¾è¯¾åé—¯å…³</title>
  <style>
    :root{
      --bg:#f6f1e7;
      --paper:#fbf7ef;
      --ink:#1e1b16;
      --muted:#6f6457;
      --gold:#b7924b;
      --shadow: 0 14px 40px rgba(0,0,0,.10);
      --radius: 18px;

      /* ä¸­å›½è‰² */
      --yuebai:#dbe8f2;   /* æœˆç™½ */
      --daiqing:#223a50;  /* é»›é’ */
      --yanzhi:#b5485a;   /* èƒ­è„‚ */
      --xuanxun:#2b1f1a;  /* ç„ */
      --xun:#d1a166;      /* çº */
      --qing:#6aa7c8;     /* é›¨è¿‡å¤©é’è¾…åŠ© */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Noto Sans SC","Microsoft YaHei", Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(106,167,200,.20), transparent 55%),
        radial-gradient(1200px 800px at 85% 25%, rgba(183,146,75,.18), transparent 55%),
        radial-gradient(1200px 800px at 60% 90%, rgba(34,58,80,.10), transparent 55%),
        linear-gradient(180deg, #f9f4ea 0%, #f6f1e7 60%, #f3ede2 100%);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* çº¸çº¹ */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='240'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='240' filter='url(%23n)' opacity='.07'/%3E%3C/svg%3E");
      pointer-events:none;
      mix-blend-mode:multiply;
      z-index:0;
    }

    /* é¡¶éƒ¨å·è½´æ  */
    header{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(251,247,239,.88), rgba(251,247,239,.55));
      border-bottom:1px solid rgba(30,27,22,.10);
    }
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:14px 18px;
      display:flex; align-items:center; gap:14px;
    }
    .seal{
      width:42px; height:42px; border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 40%),
        linear-gradient(135deg, #9b3b3b, #7b2323);
      box-shadow: 0 12px 28px rgba(0,0,0,.15);
      display:grid; place-items:center;
      color:#fff; font-weight:800;
      letter-spacing:2px;
      font-size:14px;
    }
    .titlewrap{display:flex; flex-direction:column; line-height:1.1}
    .title{
      font-weight:900;
      font-size:16px;
      letter-spacing:.8px;
    }
    .subtitle{
      font-size:12px;
      color:var(--muted);
    }
    .pill{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
      font-size:12px;
      color:var(--muted);
    }
    .progress{
      width:170px; height:10px; border-radius:999px;
      background:rgba(30,27,22,.10);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.5);
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, var(--gold), rgba(106,167,200,.9));
      border-radius:999px;
      transition: width .4s ease;
    }

    main{
      position:relative; z-index:1;
      max-width:1100px;
      margin:0 auto;
      padding:22px 18px 90px;
    }

    /* å¡ç‰‡å®¹å™¨ */
    .card{
      background: linear-gradient(180deg, rgba(251,247,239,.92), rgba(251,247,239,.80));
      border:1px solid rgba(30,27,22,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:"";
      position:absolute; inset:-40px -40px auto auto;
      width:160px; height:160px;
      background: radial-gradient(circle at 40% 40%, rgba(183,146,75,.25), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      .pill{display:none}
    }

    h1{
      font-size:26px; margin:6px 0 6px;
      letter-spacing: .8px;
    }
    h2{
      font-size:18px; margin:0 0 10px;
      letter-spacing:.6px;
    }
    p{ margin:8px 0; color:var(--muted); line-height:1.75 }
    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(30,27,22,.18), transparent);
      margin:14px 0;
    }

    /* æŒ‰é’® */
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      border:0;
      border-radius: 14px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
      background:rgba(30,27,22,.06);
      color:var(--ink);
    }
    button:hover{ box-shadow: 0 12px 20px rgba(0,0,0,.08)}
    button:active{ transform: translateY(1px) }
    .primary{
      background: linear-gradient(135deg, rgba(183,146,75,1), rgba(106,167,200, .95));
      color:#fff;
    }
    .ghost{
      background:transparent;
      border:1px solid rgba(30,27,22,.14);
    }
    .danger{
      background:linear-gradient(135deg, #9b3b3b, #6a2020);
      color:#fff;
    }

    /* å°æ ‡ç­¾ */
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(30,27,22,.06);
      border:1px solid rgba(30,27,22,.10);
      color:var(--muted);
    }

    /* è¡¨å• */
    .field{
      display:flex; flex-direction:column; gap:8px;
      margin-top:10px;
    }
    input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(30,27,22,.14);
      background: rgba(255,255,255,.55);
      outline:none;
      font-size:14px;
    }
    textarea{ min-height:110px; resize:vertical; line-height:1.7 }

    /* å…³å¡å¯¼èˆª */
    .steps{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 0;
    }
    .step{
      flex:1;
      min-width:140px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(30,27,22,.12);
      background: rgba(255,255,255,.40);
      color: var(--muted);
      display:flex; align-items:center; justify-content:space-between;
    }
    .step b{color:var(--ink)}
    .step .s{
      width:22px; height:22px;
      border-radius:8px;
      display:grid; place-items:center;
      background:rgba(30,27,22,.08);
      color:var(--ink);
      font-size:12px;
      font-weight:900;
    }
    .step.active{
      background: linear-gradient(135deg, rgba(183,146,75,.20), rgba(106,167,200,.18));
      border-color: rgba(183,146,75,.45);
      color: var(--ink);
    }
    .step.done{
      background: rgba(106,167,200,.18);
      border-color: rgba(106,167,200,.42);
    }
    .step.done .s{ background: rgba(106,167,200,.35) }

    /* é¢˜ç›®åŒº */
    .qbox{ margin-top:14px }
    .qhead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .qtitle{
      font-size:16px; font-weight:900; margin:0;
      letter-spacing:.4px;
    }
    .qmeta{
      display:flex; flex-direction:column; gap:6px; align-items:flex-end;
      min-width:140px;
    }
    .qtype{
      font-size:12px;
      color:var(--muted);
    }
    .qnum{
      font-size:12px;
      color:var(--muted);
    }
    .options{ margin:12px 0; display:grid; gap:10px }
    .opt{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(30,27,22,.12);
      background: rgba(255,255,255,.42);
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .opt:hover{ transform: translateY(-1px); border-color: rgba(183,146,75,.45) }
    .opt .mark{
      width:22px; height:22px; border-radius:9px;
      display:grid; place-items:center;
      background: rgba(30,27,22,.08);
      font-weight:900;
      font-size:12px;
      flex:0 0 auto;
    }
    .opt.selected{
      background: linear-gradient(135deg, rgba(183,146,75,.18), rgba(106,167,200,.16));
      border-color: rgba(183,146,75,.55);
    }
    .opt.correct{
      background: rgba(66, 160, 115, .16);
      border-color: rgba(66, 160, 115, .55);
    }
    .opt.wrong{
      background: rgba(155, 59, 59, .12);
      border-color: rgba(155, 59, 59, .55);
    }

    /* å³æ—¶åé¦ˆæ¡ */
    .feedback{
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(30,27,22,.10);
      background: rgba(255,255,255,.45);
      display:none;
    }
    .feedback.show{ display:block }
    .fbline{ display:flex; gap:10px; align-items:flex-start }
    .fbicon{
      width:26px; height:26px; border-radius:10px;
      display:grid; place-items:center;
      font-weight:900;
      flex:0 0 auto;
    }
    .fbicon.ok{ background: rgba(66,160,115,.18); color:#2c6a4b; border:1px solid rgba(66,160,115,.35) }
    .fbicon.no{ background: rgba(155,59,59,.16); color:#7b2323; border:1px solid rgba(155,59,59,.35) }
    .fbicon.warn{ background: rgba(183,146,75,.16); color:#7b5a22; border:1px solid rgba(183,146,75,.35) }
    .fbtitle{ font-weight:900; margin:0 }
    .fbtext{ margin:4px 0 0; color:var(--muted); line-height:1.7 }

    /* é…å¯¹é¢˜ */
    .pairwrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 700px){
      .pairwrap{grid-template-columns:1fr}
    }
    .paircol{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(30,27,22,.10);
      background: rgba(255,255,255,.35);
    }
    .paircol h3{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.4px;
    }
    .pairitem{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(30,27,22,.12);
      background: rgba(255,255,255,.42);
      cursor:pointer;
      margin-bottom:8px;
      user-select:none;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .pairitem.selected{ border-color: rgba(183,146,75,.55); background: linear-gradient(135deg, rgba(183,146,75,.16), rgba(106,167,200,.12)) }
    .pairitem.matched{ border-color: rgba(66,160,115,.55); background: rgba(66,160,115,.14) }
    .pairitem .small{ font-size:12px; color:var(--muted) }

    /* è‰²å¡ */
    .palette{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .swatch{
      width:112px;
      border-radius:18px;
      border:1px solid rgba(30,27,22,.14);
      overflow:hidden;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.08);
      transition: transform .12s ease;
      background: rgba(255,255,255,.45);
    }
    .swatch:hover{ transform: translateY(-2px) }
    .swatch .c{
      height:58px;
      position:relative;
    }
    .swatch .t{
      padding:10px 10px;
      font-weight:900;
      font-size:13px;
      display:flex; justify-content:space-between;
      align-items:center;
    }
    .swatch .t span{ color:var(--muted); font-weight:700; font-size:11px }
    .c::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.35), transparent 55%),
                  radial-gradient(circle at 75% 65%, rgba(0,0,0,.08), transparent 60%);
      mix-blend-mode:overlay;
      pointer-events:none;
    }

    /* å·è½´å¼¹çª— */
    .modalback{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      z-index:60;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modalback.show{ display:flex }
    .scroll{
      width:min(860px, 100%);
      border-radius: 26px;
      background:
        linear-gradient(180deg, rgba(251,247,239,.96), rgba(251,247,239,.88));
      border:1px solid rgba(30,27,22,.14);
      box-shadow: 0 28px 80px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      animation: pop .28s ease-out;
    }
    @keyframes pop{
      from{ transform: translateY(10px) scale(.98); opacity:.0 }
      to{ transform: translateY(0) scale(1); opacity:1 }
    }
    .scroll::before, .scroll::after{
      content:"";
      position:absolute; top:0; bottom:0;
      width:26px;
      background: linear-gradient(180deg, rgba(183,146,75,.60), rgba(183,146,75,.35));
      opacity:.65;
    }
    .scroll::before{ left:0 }
    .scroll::after{ right:0 }
    .scrollhead{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid rgba(30,27,22,.10);
    }
    .scrollhead b{ font-size:16px; letter-spacing:.6px }
    .scrollbody{
      padding:18px 22px 16px;
      display:grid;
      grid-template-columns: 1.0fr 1.0fr;
      gap:14px;
    }
    @media (max-width: 780px){
      .scrollbody{grid-template-columns:1fr}
    }
    .scrollsec{
      background: rgba(255,255,255,.42);
      border:1px solid rgba(30,27,22,.10);
      border-radius: 18px;
      padding:12px;
    }
    .scrollsec h4{ margin:0 0 8px; font-size:13px; letter-spacing:.4px }
    .scrollsec p{ margin:0; font-size:13px }
    .closex{
      border:1px solid rgba(30,27,22,.14);
      background: rgba(255,255,255,.55);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
    }

    /* æ³¼å¢¨åŠ¨ç”»å±‚ */
    .inkburst{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:58;
      display:none;
    }
    .inkburst.show{display:block}
    .splash{
      position:absolute;
      width:30px; height:30px;
      border-radius: 999px;
      opacity:.0;
      filter: blur(.2px);
      transform: translate(-50%, -50%) scale(.2);
      animation: splash 700ms ease-out forwards;
      mix-blend-mode:multiply;
    }
    @keyframes splash{
      0%{ opacity:.0; transform: translate(-50%,-50%) scale(.2) }
      15%{ opacity:.35 }
      65%{ opacity:.22 }
      100%{ opacity:0; transform: translate(-50%,-50%) scale(11) }
    }

    /* æ’è¡Œæ¦œ */
    .rank{
      margin-top:10px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(30,27,22,.10);
      background: rgba(255,255,255,.35);
    }
    .rank .rhead{
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(30,27,22,.10);
      font-weight:900;
    }
    .rank table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .rank td, .rank th{
      padding:10px 12px;
      border-bottom:1px solid rgba(30,27,22,.08);
      text-align:left;
    }
    .rank tr:last-child td{border-bottom:0}
    .medal{ font-weight:900 }
    .muted{ color:var(--muted) }

    /* åº•éƒ¨æç¤º */
    .footnote{
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
      line-height:1.7;
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="seal">å°</div>
    <div class="titlewrap">
      <div class="title">ã€Šä¸­å›½è‰²çš„è¯—æ„ã€‹å¾®è¯¾ï½œè¯¾åé—¯å…³ç­”é¢˜</div>
      <div class="subtitle">ä¹å¹´çº§ï½œè‰²ä¹‹å Â· è‰²ä¹‹é­‚ Â· è‰²ä¹‹éŸµ Â· ç»¼åˆè¡¨è¾¾</div>
    </div>
    <div class="pill">
      <span id="userMini">æœªç™»å½•</span>
      <div class="progress" title="é—¯å…³è¿›åº¦">
        <div class="bar" id="bar"></div>
      </div>
    </div>
  </div>
</header>

<div class="inkburst" id="inkburst"></div>

<div class="modalback" id="modalBack" aria-hidden="true">
  <div class="scroll" role="dialog" aria-modal="true">
    <div class="scrollhead">
      <b id="scrollTitle">å·è½´</b>
      <button class="closex" id="closeModal">æ”¶èµ·</button>
    </div>
    <div class="scrollbody">
      <div class="scrollsec">
        <h4>è‰²æ„Ÿè§£é‡Š</h4>
        <p id="mFeel">â€”</p>
      </div>
      <div class="scrollsec">
        <h4>æ¥æºè¯´æ˜</h4>
        <p id="mFrom">â€”</p>
      </div>
      <div class="scrollsec">
        <h4>æ„è±¡å…³é”®è¯</h4>
        <p id="mKeys">â€”</p>
      </div>
      <div class="scrollsec">
        <h4>å†™ä½œå¥å¼ç¤ºèŒƒ + â€œæŒ‘æˆ˜ä¸€å¥â€</h4>
        <p id="mSentence">â€”</p>
      </div>
    </div>
    <div style="padding:0 22px 18px; color:var(--muted); font-size:12px; line-height:1.7">
      å°è´´å£«ï¼šæŠŠè‰²å¡å½“ä½œâ€œè¯—æ„è¯åº“â€ï¼Œå†™ä½œæ—¶å¯éšæ—¶æ‰“å¼€å·è½´å–å¥å¼ä¸æ„è±¡ã€‚
    </div>
  </div>
</div>

<main>
  <div class="grid">
    <!-- å·¦ä¾§ä¸»åŒº -->
    <section class="card" id="stage"></section>

    <!-- å³ä¾§ä¾§æ  -->
    <aside class="card">
      <h2>é—¯å…³åœ°å›¾</h2>
      <div class="steps" id="stepNav"></div>

      <div class="divider"></div>

      <h2>å›½é£è‰²å¡ï¼ˆéšå†™éšç”¨ï¼‰</h2>
      <p style="margin-top:4px">ç‚¹è‰²å¡ï¼Œæ³¼å¢¨æ™•æŸ“ â†’ å·è½´å¼¹çª—ã€‚å¯ç”¨äºå†™ä½œè¡¨è¾¾ã€‚</p>
      <div class="palette" id="paletteSide"></div>

      <div class="divider"></div>

      <h2>æ’è¡Œæ¦œ</h2>
      <p style="margin-top:4px">æˆç»©ä¿å­˜åœ¨æœ¬æœºï¼ˆç¦»çº¿å¯ç”¨ï¼‰ï¼ŒæŒ‰â€œç»¼åˆåˆ†â€æ’åºã€‚</p>
      <div class="rank" id="rankBox"></div>
      <div class="btnrow">
        <button class="ghost" id="btnRefreshRank">åˆ·æ–°æ¦œå•</button>
        <button class="danger" id="btnClearRank">æ¸…ç©ºæ¦œå•</button>
      </div>

      <div class="footnote">
            </aside>
  </div>
</main>

<script>
/* ===========================
   1) è‰²å¡å·è½´å†…å®¹
=========================== */
const COLOR_SCROLL = {
  "æœˆç™½": {
    hex: getComputedStyle(document.documentElement).getPropertyValue('--yuebai').trim(),
    feel: "æ¸…å†·è€ŒæŸ”å’Œï¼Œåƒæœˆå…‰åœ¨æ°´é¢ä¸Šè½»è½»é“ºå¼€ï¼Œå¸¦ä¸€ç‚¹æµ…è“ä¸æ³›ç»¿çš„æ°”æ¯ã€‚",
    from: "æºäºæœˆè‰²çš„å¾®å…‰ä¸è–„é›¾çš„åå°„ï¼Œä¸æ˜¯çº¯ç™½ï¼Œè€Œæ˜¯â€œç™½ä¸­å¸¦é’â€ã€‚",
    keys: "æ¸…è¾‰ / è–„é›¾ / é™å¤œ / ç©ºæ˜ / è½»å¯’",
    sentence: "å¥å¼ç¤ºèŒƒï¼š<b>â€œæœˆç™½çš„å…‰åƒ____ï¼ŒæŠŠ____ç…§å¾—____ã€‚â€</b><br>æŒ‘æˆ˜ä¸€å¥ï¼šç”¨â€œæœˆç™½â€å†™ä¸€å¥æå†™å¤œæ™¯æˆ–å¿ƒæƒ…çš„è¯ã€‚"
  },
  "é»›é’": {
    hex: getComputedStyle(document.documentElement).getPropertyValue('--daiqing').trim(),
    feel: "æ·±æ²‰åšé‡ï¼Œåƒè¿œå±±å å½±ï¼ŒåˆåƒåœŸåœ°çš„åº•è‰²ï¼Œå®‰é™å´æœ‰åŠ›é‡ã€‚",
    from: "æºäºè¿œå±±çš„é’é»‘ä¸ç”»çœ‰ç”¨çš„â€œé»›â€è‰²çŸ¿ç‰©ï¼Œå¸¦æœ‰å¤å…¸çš„æ²‰ç¨³æ°”è´¨ã€‚",
    keys: "è¿œå±± / åœŸåœ° / æ²‰é™ / åšéŸ§ / æ·±æƒ…",
    sentence: "å¥å¼ç¤ºèŒƒï¼š<b>â€œé»›é’çš„____ï¼Œè®©____æ˜¾å¾—____ã€‚â€</b><br>æŒ‘æˆ˜ä¸€å¥ï¼šç”¨â€œé»›é’â€å†™ä¸€å¥æå†™å±±ã€åœŸåœ°æˆ–åšå®ˆçš„å¥å­ã€‚"
  },
  "èƒ­è„‚": {
    hex: getComputedStyle(document.documentElement).getPropertyValue('--yanzhi').trim(),
    feel: "é²œæ´»æ˜ä¸½ï¼Œåƒæ™¨æ›¦ä¸èŠ±ç“£çš„çƒ­åº¦ï¼Œæœ‰äººé—´çƒŸç«ï¼Œä¹Ÿæœ‰ç››å”æ°”è±¡ã€‚",
    from: "æºäºå¦†å¥ä¸­çš„èƒ­è„‚è‰²ä¸ç”Ÿæ´»ç¾æ„Ÿï¼Œåæ¥ä¹Ÿæˆä¸ºè¯—è¯é‡Œâ€œé»æ˜â€â€œèŠ±è‰²â€çš„æ–‡åŒ–ç¬¦å·ã€‚",
    keys: "æ™¨å…‰ / èŠ±ç“£ / çƒ­çƒˆ / ç”Ÿæœº / çƒŸç«æ°”",
    sentence: "å¥å¼ç¤ºèŒƒï¼š<b>â€œèƒ­è„‚è‰²çš„____ï¼Œåœ¨____é‡Œ____ã€‚â€</b><br>æŒ‘æˆ˜ä¸€å¥ï¼šç”¨â€œèƒ­è„‚â€å†™ä¸€å¥æå†™é»æ˜ã€èŠ±æˆ–çƒ­æƒ…çš„å¥å­ã€‚"
  },
  "ç„çº": {
    hex: getComputedStyle(document.documentElement).getPropertyValue('--xuanxun').trim(),
    feel: "åº„é‡è‚ƒç©†ï¼šç„å¦‚æ·±å¤œè‹ç©¹ï¼Œçºå¦‚é»„æ˜è½æ—¥ï¼Œå¤©åœ°ä¹‹è‰²ï¼Œå«æ•¬ç•ä¸ä»ªå¼æ„Ÿã€‚",
    from: "å¤ä»£éš†é‡ç¤¼æœä¹‹è‰²ï¼šä¸Šè¡£â€œç„â€ï¼ˆè±¡å¤©ï¼‰ï¼Œä¸‹è£³â€œçºâ€ï¼ˆè±¡åœ°ï¼‰ï¼Œå¯“æ„å¯¹å¤©åœ°çš„æ•¬æ„ä¸ç§©åºã€‚",
    keys: "å¤©åœ° / ç¤¼ä»ª / æ•¬æ„ / å®¶å›½ / åº„ä¸¥",
    sentence: "å¥å¼ç¤ºèŒƒï¼š<b>â€œç„çºçš„____ï¼Œåƒ____ï¼Œè®©äººæƒ³åˆ°____ã€‚â€</b><br>æŒ‘æˆ˜ä¸€å¥ï¼šç”¨â€œç„çºâ€å†™ä¸€å¥ä¸â€œå®¶å›½ã€æ•¬æ„ã€ä»ªå¼â€ç›¸å…³çš„å¥å­ã€‚"
  }
};

/* ===========================
   2) å…³å¡ç»“æ„
=========================== */
const LEVELS = [
  { id:"intro", name:"å¯¼å…¥", short:"é›¨è¿‡å¤©é’", type:"intro" },
  { id:"name", name:"è‰²ä¹‹å", short:"åä¸­æœ‰ç”»", type:"quiz" },
  { id:"soul", name:"è‰²ä¹‹é­‚", short:"è‰²ä¸­æœ‰æƒ…", type:"quiz" },
  { id:"rhyme", name:"è‰²ä¹‹éŸµ", short:"æ–‡åŒ–ä¹‹éŸµ", type:"quiz" },
  { id:"all", name:"ç»¼åˆÂ·è¡¨è¾¾", short:"å†™å‡ºè¯—æ„", type:"quiz" },
  { id:"result", name:"ç»“ç®—", short:"å­¦ä¹ å»ºè®®", type:"result" }
];

/* ===========================
   3) é¢˜åº“ï¼šå®¢è§‚é¢˜è®¡æ­£ç¡®ç‡ï¼›è¡¨è¾¾é¢˜ä¸åˆ¤å¯¹é”™
=========================== */
const QUESTIONS = {
  name: [
    {
      id:"n1",
      type:"single",
      stem:"ã€å•é€‰ã€‘â€œæœˆç™½â€æ›´æ¥è¿‘ä¸‹é¢å“ªä¸€ç§ç†è§£ï¼Ÿ",
      options:[
        "çº¯ç™½æ— è‰²ï¼Œåƒç²‰ç¬”ä¸€æ ·ç™½",
        "æœˆå…‰çš„æµ…è“æ³›ç»¿ï¼Œæ¸…å†·æŸ”å’Œ",
        "æµ“çƒˆå¤§çº¢ï¼Œåƒæ™šéœ",
        "æ·±é»‘å¦‚å¢¨ï¼Œæ²‰é‡å‹æŠ‘"
      ],
      answer:[1],
      explain:"â€œæœˆç™½â€ä¸æ˜¯çº¯ç™½ï¼Œè€Œæ˜¯å¸¦æµ…è“ä¸æ³›ç»¿çš„æœˆå…‰è‰²ï¼Œåä¸­æœ‰ç”»ã€‚"
    },
    {
      id:"n2",
      type:"multi",
      stem:"ã€å¤šé€‰ã€‘ä»¥ä¸‹å“ªäº›ç‰¹ç‚¹ç¬¦åˆâ€œä¸­å›½ä¼ ç»Ÿè‰²åâ€çš„å‘½åæ™ºæ…§ï¼Ÿï¼ˆæœ¬é¢˜ï¼šç‚¹å‡»ä¸‹ä¸€é¢˜æ—¶åˆ¤å®šï¼‰",
      options:[
        "ä»è‡ªç„¶è§‚å¯Ÿä¸­å–è±¡",
        "ä»…ç”¨ç§‘å­¦æ³¢é•¿æ¥å‘½å",
        "å¸¸å¸¦æƒ…æ„Ÿä¸æ„å¢ƒ",
        "ä¸ç”Ÿæ´»ç»éªŒå¯†åˆ‡ç›¸å…³"
      ],
      answer:[0,2,3],
      explain:"ä¼ ç»Ÿè‰²åå¾€å¾€â€œæºäºè‡ªç„¶/ç”Ÿæ´»â€ï¼Œå¹¶æ‰¿è½½æƒ…æ„Ÿæ„å¢ƒï¼Œè€Œéçº¯ç§‘å­¦å‚æ•°ã€‚"
    },
    {
      id:"n3",
      type:"pair",
      stem:"ã€é…å¯¹ã€‘æŠŠä¼ ç»Ÿè‰²åä¸æ›´è´´è¿‘çš„æ„è±¡/æ¥æºé…å¯¹ï¼ˆç‚¹å·¦å†ç‚¹å³ï¼‰ï¼š",
      left:[
        {k:"æœˆç™½", v:"æœˆå…‰å¾®å†·çš„æµ…è“æ³›ç»¿"},
        {k:"é»›é’", v:"è¿œå±±/ç”»çœ‰é»›è‰²çš„æ·±æ²‰é’é»‘"},
        {k:"èƒ­è„‚", v:"å¦†å¥/èŠ±ç“£èˆ¬çš„é²œæ´»ç»¯çº¢"}
      ],
      right:[
        {k:"A", v:"å¦†å®¹Â·é²œæ´»ç»¯çº¢"},
        {k:"B", v:"æœˆè‰²Â·æµ…è“æ³›ç»¿"},
        {k:"C", v:"è¿œå±±Â·æ·±æ²‰é’é»‘"}
      ],
      answerMap:{
        "æœˆç™½":"B",
        "é»›é’":"C",
        "èƒ­è„‚":"A"
      },
      explain:"å‘½åå¸¸å–è‡ªç„¶ä¸ç”Ÿæ´»ï¼šæœˆç™½å–æœˆè‰²ï¼Œé»›é’å–è¿œå±±ä¸é»›ï¼Œèƒ­è„‚å–å¦†å¥ä¸èŠ±è‰²ã€‚"
    }
  ],
  soul: [
    {
      id:"s1",
      type:"single",
      stem:"ã€å•é€‰ã€‘ã€Šæš®æ±ŸåŸã€‹ä¸­â€œåŠæ±Ÿç‘Ÿç‘ŸåŠæ±Ÿçº¢â€æœ€çªå‡ºçš„è‰²å½©è¡¨è¾¾æ•ˆæœæ˜¯ï¼š",
      options:[
        "å•ä¸€è‰²è°ƒï¼Œè¥é€ å‹æŠ‘",
        "å†·æš–å¯¹æ¯”ï¼Œæ•æ‰å…‰å½±å˜åŒ–ä¸å¾®å¦™æƒ…æ„Ÿ",
        "å…¨é å¤¸å¼ æ¯”å–»ï¼Œä¸å«ç”»é¢",
        "è‰²å½©æ‚ä¹±ï¼Œæ— æ³•æƒ³è±¡"
      ],
      answer:[1],
      explain:"å†·æš–å¯¹æ¯”å½¢æˆç”»é¢å¼ åŠ›ï¼Œè¡¨ç°å‚æ™šæ±Ÿé¢å…‰å½±ä¸æƒ…ç»ªå˜åŒ–ã€‚"
    },
    {
      id:"s2",
      type:"multi",
      stem:"ã€å¤šé€‰ã€‘ã€Šåƒé‡Œæ±Ÿå±±å›¾ã€‹ä¸­â€œçŸ³é’ã€çŸ³ç»¿æ¸²æŸ“â€èƒ½è¥é€ æ€æ ·çš„æ„å¢ƒï¼Ÿï¼ˆæœ¬é¢˜ï¼šç‚¹å‡»ä¸‹ä¸€é¢˜æ—¶åˆ¤å®šï¼‰",
      options:[
        "å±‚æ¬¡åˆ†æ˜ï¼Œè®©å±±æ²³æ›´å£®é˜”",
        "ä½¿ç”»é¢æ›´å¹³é¢ã€æ›´å•è°ƒ",
        "è®©è‰²å½©â€œå‘¼å¸â€ï¼Œå…·æœ‰ç”Ÿå‘½æ„Ÿ",
        "ä¸â€œå®¶å›½æƒ…æ€€â€çš„è¡¨è¾¾å¯å‘ç”Ÿå…³è”"
      ],
      answer:[0,2,3],
      explain:"æ¸²æŸ“è®©è‰²å½©æœ‰å±‚æ¬¡ã€æœ‰çµé­‚ï¼Œå½¢æˆå£®é˜”æ°”è±¡ï¼Œå¹¶èƒ½æ‰¿è½½æƒ…æ„Ÿä¸ä»·å€¼æŒ‡å‘ã€‚"
    }
  ],
  rhyme: [
    {
      id:"r1",
      type:"single",
      stem:"ã€å•é€‰ã€‘â€œç„çºâ€åœ¨ä¼ ç»Ÿæ–‡åŒ–ä¸­æ›´ä¾§é‡è±¡å¾ï¼š",
      options:[
        "éšæ„æ­é…çš„æµè¡Œé…è‰²",
        "å¤©åœ°ä¹‹è‰²ä¸ç¤¼ä»ªæ•¬æ„",
        "å„¿ç«¥ç»˜ç”»çš„å½©è™¹è‰²",
        "çº¯è£…é¥°ï¼Œæ— æ„ä¹‰"
      ],
      answer:[1],
      explain:"ç„ä¸ºå¤©ã€çºä¸ºåœ°ï¼Œæœé¥°è‰²å½©è±¡å¾æ•¬å¤©æ³•åœ°ï¼Œå«ä»ªå¼ä¸å®¶å›½ç§©åºã€‚"
    },
    {
      id:"r2",
      type:"pair",
      stem:"ã€é…å¯¹ã€‘æŠŠâ€œè‰²â†’æ–‡åŒ–å«ä¹‰/ç°ä»£åº”ç”¨â€é…å¯¹ï¼š",
      left:[
        {k:"ç„çº", v:"è±¡å¾å¤©åœ°æ•¬æ„ã€ç¤¼ä»ªåº„é‡"},
        {k:"èƒ­è„‚", v:"ä»å¦†å®¹åˆ°å›½æ½®è®¾è®¡çš„ç”Ÿæ´»å®¡ç¾"}
      ],
      right:[
        {k:"A", v:"ç¤¼ä»ªÂ·å¤©åœ°Â·å®¶å›½ç§©åº"},
        {k:"B", v:"ç”Ÿæ´»Â·å¦†å®¹Â·ç°ä»£å›½æ½®"}
      ],
      answerMap:{
        "ç„çº":"A",
        "èƒ­è„‚":"B"
      },
      explain:"ç„çºåç¤¼ä»ªå“²æ€ï¼›èƒ­è„‚æ›´ä½“ç°ç”Ÿæ´»ç¾æ„Ÿä¸å¤ä»Šä¼ æ‰¿ã€‚"
    }
  ],
  all: [
    {
      id:"a1",
      type:"single",
      stem:"ã€å•é€‰ã€‘å¦‚æœç”¨ä¼ ç»Ÿè‰²åæ¥æ›¿ä»£â€œæµ…è“ç™½çš„é›ªæ™¯â€ï¼Œæ›´è´´è¿‘çš„æ˜¯ï¼š",
      options:[
        "èƒ­è„‚",
        "é»›é’",
        "æœˆç™½",
        "ç„çº"
      ],
      answer:[2],
      explain:"é›ªæ™¯çš„æ¸…å†·ç©ºæ˜æ›´æ¥è¿‘â€œæœˆç™½â€çš„æ°”è´¨ï¼ˆç™½ä¸­å¸¦é’ï¼Œæ¸…è¾‰ä¹‹æ„ï¼‰ã€‚"
    },
    {
      id:"a2",
      type:"multi",
      stem:"ã€å¤šé€‰ã€‘å®Œæˆâ€œå®¡ç¾è¡¨è¾¾â€æ—¶ï¼Œå“ªäº›åšæ³•æ›´èƒ½å†™å‡ºâ€œè¯—æ„â€ï¼Ÿï¼ˆæœ¬é¢˜ï¼šç‚¹å‡»ä¸‹ä¸€é¢˜æ—¶åˆ¤å®šï¼‰",
      options:[
        "åªå†™â€œå¥½çœ‹ã€å¾ˆç¾â€",
        "ç”¨â€œæºäºXX/è¥é€ XXæ„å¢ƒâ€ç­‰å¥å¼",
        "ç»“åˆæ„è±¡ï¼ˆå¦‚è¿œå±±ã€æœˆå…‰ã€é»æ˜ï¼‰",
        "æŠŠè‰²å½©ä¸æƒ…æ„Ÿ/æ–‡åŒ–è”ç³»èµ·æ¥"
      ],
      answer:[1,2,3],
      explain:"ä¹å¹´çº§è¡¨è¾¾åº”æ›´â€œå…·ä½“+æœ‰èŒƒå¼â€ï¼šå¥å¼ã€æ„è±¡ã€æƒ…æ„Ÿä¸æ–‡åŒ–è”ç»“ï¼Œè®©è¯­è¨€æ›´æœ‰åŠ›é‡ã€‚"
    },
    {
      id:"a3",
      type:"express",
      stem:"ã€è¡¨è¾¾é¢˜ã€‘è¯·ç”¨è‡³å°‘1ä¸ªä¼ ç»Ÿè‰²åï¼ˆå¦‚æœˆç™½/é»›é’/èƒ­è„‚/ç„çºï¼‰å†™ä¸€æ®µæå†™ï¼ˆ60â€”120å­—ï¼‰ï¼Œæå†™â€œçª—å¤–æ™¯è‰²â€æˆ–â€œæ­¤åˆ»å¿ƒæƒ…â€ã€‚",
      tips:[
        "å»ºè®®ç»“æ„ï¼šè‰²å â†’ æ¥æº/æ„è±¡ â†’ ç”»é¢ç»†èŠ‚ â†’ æƒ…æ„Ÿæˆ–æ„ä¹‰",
        "å¯ç”¨å¥å¼ï¼šâ‘ â€œ____çš„å…‰åƒ____ï¼ŒæŠŠ____ç…§å¾—____ã€‚â€",
        "å¯ç”¨å¥å¼ï¼šâ‘¡â€œ____çš„____ï¼Œè®©____æ˜¾å¾—____ã€‚â€",
        "å¯åŠ å…¥ï¼šå®¶å›½/æ•¬æ„/ä¼ æ‰¿/ç”Ÿæ´»æ°”æ¯ç­‰æ–‡åŒ–è”æƒ³"
      ]
    }
  ]
};

/* ===========================
   4) çŠ¶æ€ï¼šæ–°å¢è®¡æ—¶ä¸æ­£ç¡®ç‡
=========================== */
const state = {
  user: { name:"", cls:"" },
  levelIndex: 0,
  qIndex: 0,

  startTime: 0,
  usedSeconds: 0,

  correctCount: 0,
  wrongCount: 0,
  judged: {},

  totalObjective: countObjective(),
  doneObjective: 0,
  doneExpress: 0,

  answers: {},
  pairTemp: { left:null, right:null },
  pairMap: {},

  score: 0
};

function countObjective(){
  let total = 0;
  for(const k of ["name","soul","rhyme","all"]){
    for(const q of QUESTIONS[k]){
      if(q.type !== "express") total++;
    }
  }
  return total;
}

/* ===========================
   5) åˆå§‹åŒ–
=========================== */
const $ = (id)=>document.getElementById(id);

renderStepNav();
renderPalette($("paletteSide"));
bindRankButtons();
render();

/* ===========================
   6) UIï¼šé—¯å…³å¯¼èˆª
=========================== */
function renderStepNav(){
  const nav = $("stepNav");
  nav.innerHTML = "";
  LEVELS.forEach((lv, idx)=>{
    const div = document.createElement("div");
    div.className = "step" + (idx===state.levelIndex ? " active" : "") + (idx<state.levelIndex ? " done" : "");
    div.innerHTML = `<div><b>${lv.name}</b><div class="muted" style="font-size:12px;margin-top:2px">${lv.short}</div></div><div class="s">${idx+1}</div>`;
    div.style.cursor = idx<=state.levelIndex ? "pointer":"not-allowed";
    div.onclick = ()=>{
      if(idx<=state.levelIndex){
        state.levelIndex = idx;
        state.qIndex = 0;
        render();
      }
    };
    nav.appendChild(div);
  });
}

function updateTopProgress(){
  const completed = getCompletion();
  $("bar").style.width = completed + "%";
  $("userMini").textContent = state.user.name ? `${state.user.name}ï½œ${state.user.cls}` : "æœªç™»å½•";
}

function getCompletion(){
  const total = state.totalObjective + 1; // +è¡¨è¾¾é¢˜
  const done = state.doneObjective + state.doneExpress;
  return Math.round(done / total * 100);
}

/* ===========================
   7) è‰²å¡ä¸å·è½´
=========================== */
function renderPalette(container){
  container.innerHTML = "";
  const list = ["æœˆç™½","é»›é’","èƒ­è„‚","ç„çº"];
  list.forEach(name=>{
    const sw = document.createElement("div");
    sw.className = "swatch";
    const c = document.createElement("div");
    c.className = "c";
    c.style.background = (name==="ç„çº")
      ? `linear-gradient(90deg, var(--xuanxun), var(--xun))`
      : COLOR_SCROLL[name].hex;
    const t = document.createElement("div");
    t.className = "t";
    t.innerHTML = `${name} <span>å·è½´</span>`;
    sw.appendChild(c); sw.appendChild(t);
    sw.onclick = (e)=>{
      inkSplash(e.clientX, e.clientY, name);
      openScroll(name);
    };
    container.appendChild(sw);
  });
}

function openScroll(colorName){
  const data = COLOR_SCROLL[colorName];
  $("scrollTitle").textContent = `ã€${colorName}ã€‘å·è½´`;
  $("mFeel").innerHTML = data.feel;
  $("mFrom").innerHTML = data.from;
  $("mKeys").innerHTML = data.keys;
  $("mSentence").innerHTML = data.sentence;
  $("modalBack").classList.add("show");
  $("modalBack").setAttribute("aria-hidden","false");
}
$("closeModal").onclick = closeModal;
$("modalBack").onclick = (e)=>{
  if(e.target.id==="modalBack") closeModal();
};
function closeModal(){
  $("modalBack").classList.remove("show");
  $("modalBack").setAttribute("aria-hidden","true");
}

function inkSplash(x,y, colorName){
  const layer = $("inkburst");
  layer.innerHTML = "";
  layer.classList.add("show");
  const base = (colorName==="ç„çº") ? "#2b1f1a" : COLOR_SCROLL[colorName].hex;
  for(let i=0;i<9;i++){
    const s = document.createElement("div");
    s.className = "splash";
    s.style.left = x + (Math.random()*80-40) + "px";
    s.style.top = y + (Math.random()*80-40) + "px";
    s.style.background = base;
    s.style.animationDelay = (Math.random()*80) + "ms";
    s.style.animationDuration = (520 + Math.random()*300) + "ms";
    layer.appendChild(s);
  }
  setTimeout(()=>layer.classList.remove("show"), 900);
}

/* ===========================
   8) æ’è¡Œæ¦œï¼ˆlocalStorageï¼‰
=========================== */
const RANK_KEY = "china_color_rank_v2";
function loadRank(){
  try{ return JSON.parse(localStorage.getItem(RANK_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveRank(list){
  localStorage.setItem(RANK_KEY, JSON.stringify(list));
}
function addRankEntry(entry){
  const list = loadRank();
  list.push(entry);
  list.sort((a,b)=> b.score - a.score || a.seconds - b.seconds || b.accuracy - a.accuracy);
  saveRank(list.slice(0,20));
}
function renderRank(){
  const list = loadRank();
  const box = $("rankBox");
  if(!list.length){
    box.innerHTML = `<div class="rhead">æš‚æ— è®°å½• <span class="muted">å¿«å»é—¯å…³</span></div>
      <div style="padding:12px;color:var(--muted);font-size:13px;line-height:1.7">å®Œæˆé—¯å…³åä¼šè‡ªåŠ¨å†™å…¥æ’è¡Œæ¦œï¼ˆæœ¬æœºä¿å­˜ï¼‰ã€‚</div>`;
    return;
  }
  const rows = list.map((r,idx)=>{
    const medal = idx===0?"ğŸ¥‡":idx===1?"ğŸ¥ˆ":idx===2?"ğŸ¥‰":`${idx+1}`;
    const dt = new Date(r.time);
    const dateStr = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
    return `<tr>
      <td class="medal">${medal}</td>
      <td><b>${escapeHtml(r.name)}</b><div class="muted" style="font-size:12px;margin-top:2px">${escapeHtml(r.cls)}</div></td>
      <td><b>${r.score}</b>/100</td>
      <td class="muted">${r.accuracy}%</td>
      <td class="muted">${fmtTime(r.seconds)}</td>
      <td class="muted">${r.complete}%</td>
      <td class="muted">${dateStr}</td>
    </tr>`;
  }).join("");
  box.innerHTML = `
    <div class="rhead">Top 20 <span class="muted">ç»¼åˆåˆ†æ¦œ</span></div>
    <table>
      <thead>
        <tr><th>åæ¬¡</th><th>åŒå­¦</th><th>ç»¼åˆåˆ†</th><th>æ­£ç¡®ç‡</th><th>ç”¨æ—¶</th><th>å®Œæˆåº¦</th><th>æ—¥æœŸ</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}
function bindRankButtons(){
  $("btnRefreshRank").onclick = renderRank;
  $("btnClearRank").onclick = ()=>{
    if(confirm("ç¡®å®šæ¸…ç©ºæ’è¡Œæ¦œï¼Ÿï¼ˆä»…æ¸…ç©ºæœ¬æœºè®°å½•ï¼‰")){
      localStorage.removeItem(RANK_KEY);
      renderRank();
    }
  };
}
renderRank();

/* ===========================
   9) æ¸²æŸ“ä¸»åŒº
=========================== */
function render(){
  updateTopProgress();
  renderStepNav();

  const lv = LEVELS[state.levelIndex];
  const stage = $("stage");
  stage.innerHTML = "";

  if(lv.type==="intro") stage.appendChild(renderIntro());
  else if(lv.id==="result") stage.appendChild(renderResult());
  else stage.appendChild(renderQuizLevel(lv.id));
}

function renderIntro(){
  const wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="tag">æƒ…å¢ƒå¯¼å…¥ Â· é›¨è¿‡å¤©é’</div>
    <h1>é›¨è¿‡å¤©é’ï¼Œé‚‚é€…ä¸­å›½è‰²çš„è¯—æ„</h1>
    <p>
      å½“ä½ è¯´â€œæ·¡è“â€â€œæµ…ç°â€ï¼Œå¤äººå´è¯´ï¼š<b>é›¨è¿‡å¤©é’</b>ã€‚<br>
      ä¸­å›½è‰²ï¼Œä¸åªæ˜¯é¢œè‰²ï¼Œæ›´æ˜¯<b>åå­—é‡Œçš„ç”»</b>ã€<b>è‰²å½©é‡Œçš„æƒ…</b>ã€<b>æ–‡åŒ–é‡Œçš„é­‚</b>ã€‚
    </p>
    <div class="divider"></div>
    <h2>å¡«å†™é—¯å…³ä¿¡æ¯</h2>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
      <div class="field">
        <label class="muted">å§“å</label>
        <input id="inpName" placeholder="è¯·è¾“å…¥å§“åï¼ˆç”¨äºæ’è¡Œæ¦œï¼‰" maxlength="12"/>
      </div>
      <div class="field">
        <label class="muted">ç­çº§</label>
        <input id="inpClass" placeholder="å¦‚ï¼šä¹ï¼ˆ3ï¼‰ç­" maxlength="12"/>
      </div>
    </div>

    <div class="divider"></div>
    <h2>å››å¼ å›½é£è‰²å¡ï¼ˆç‚¹å¼€å·è½´ï¼‰</h2>
    <p style="margin-top:6px">å†™ä½œæ—¶å¯éšæ—¶æ‰“å¼€è‰²å¡è·å–æ„è±¡ä¸å¥å¼ã€‚</p>
    <div class="palette" id="paletteIntro"></div>

    <div class="btnrow">
      <button class="primary" id="btnStart">å¼€å§‹é—¯å…³</button>
      <button class="ghost" id="btnSkipUser">æˆ‘å…ˆä¸å¡«ï¼ˆä»å¯é—¯å…³ï¼‰</button>
    </div>

    <div class="footnote">
      <b>é—¯å…³æç¤ºï¼š</b>å¤šé€‰é¢˜å°†åœ¨ç‚¹å‡»â€œä¸‹ä¸€é¢˜/ä¸‹ä¸€å…³â€æ—¶åˆ¤å®šå¹¶ç»™è§£æï¼›ä¸è¦æ±‚å…¨å¯¹æ‰èƒ½å‰è¿›ã€‚<br>
      <b>è®¡åˆ†æ–¹å¼ï¼š</b>æ­£ç¡®ç‡ + ç”¨æ—¶ ç»¼åˆè¯„åˆ†ï¼ˆ0â€”100ï¼‰ï¼Œæ’è¡Œæ¦œæŒ‰ç»¼åˆåˆ†æ’åºã€‚
    </div>
  `;
  setTimeout(()=>{
    renderPalette($("paletteIntro"));

    const saved = JSON.parse(localStorage.getItem("china_color_user_v1")||"{}");
    if(saved.name) $("inpName").value = saved.name;
    if(saved.cls) $("inpClass").value = saved.cls;

    $("btnStart").onclick = ()=>{
      const name = $("inpName").value.trim();
      const cls = $("inpClass").value.trim();
      state.user.name = name || "åŒ¿ååŒå­¦";
      state.user.cls = cls || "ä¹å¹´çº§";
      localStorage.setItem("china_color_user_v1", JSON.stringify({name:state.user.name, cls:state.user.cls}));
      state.startTime = Date.now(); // âœ… å¼€å§‹è®¡æ—¶
      nextLevel();
    };
    $("btnSkipUser").onclick = ()=>{
      state.user.name = "åŒ¿ååŒå­¦";
      state.user.cls = "ä¹å¹´çº§";
      state.startTime = Date.now(); // âœ… å¼€å§‹è®¡æ—¶
      nextLevel();
    };
  },0);

  return wrap;
}

function renderQuizLevel(levelId){
  const wrap = document.createElement("div");

  const titleMap = {
    name: {tag:"è‰²ä¹‹å", h:"åä¸­æœ‰ç”»ï¼šæºäºä¸‡ç‰©", p:"è®¤è¯†è‰²åçš„è¯—æ€§å‘½åä¸æ¥æºï¼ŒæŠŠç°ä»£â€œæµ…è“/æ·±çº¢â€å˜æˆæ›´æœ‰ç”»é¢æ„Ÿçš„ä¸­å›½è‰²ã€‚"},
    soul: {tag:"è‰²ä¹‹é­‚", h:"è‰²ä¸­æœ‰æƒ…ï¼šè¯—ç”»æ„å¢ƒä¼šå‘¼å¸", p:"ç†è§£è‰²å½©å¦‚ä½•è¥é€ æ„å¢ƒä¸æƒ…æ„Ÿï¼šæ¸²æŸ“ã€å†·æš–å¯¹æ¯”ï¼Œè®©è‰²å½©æˆä¸ºè¯—ç”»çš„å‘¼å¸ã€‚"},
    rhyme:{tag:"è‰²ä¹‹éŸµ", h:"è‰²é‡Œæœ‰æ–‡åŒ–ï¼šå¤ä»Šä¼ æ‰¿çš„éŸµ", p:"ä»â€œç„çºâ€çš„å¤©åœ°æ•¬æ„åˆ°â€œèƒ­è„‚â€çš„ç”Ÿæ´»ç¾å­¦ï¼Œè¯»æ‡‚è‰²å½©èƒŒåçš„æ–‡åŒ–åŸºå› ã€‚"},
    all:  {tag:"ç»¼åˆÂ·è¡¨è¾¾", h:"æŠŠä¸­å›½è‰²å†™è¿›ä½ çš„æ–‡å­—", p:"å°†è‰²åã€æ„è±¡ã€å¥å¼ç»„åˆï¼Œå†™å‡ºæœ‰â€œè¯—æ„â€çš„æå†™ã€‚"}
  };
  const info = titleMap[levelId];

  wrap.innerHTML = `
    <div class="tag">${info.tag}</div>
    <h1>${info.h}</h1>
    <p>${info.p}</p>
    <div class="divider"></div>
    <div id="qArea"></div>
    <div class="btnrow" id="qActions"></div>
  `;

  setTimeout(()=>renderQuestion(levelId),0);
  return wrap;
}

function renderQuestion(levelId){
  const qArea = $("qArea");
  const qActions = $("qActions");
  qArea.innerHTML = "";
  qActions.innerHTML = "";

  const qs = QUESTIONS[levelId];
  const q = qs[state.qIndex];

  const head = document.createElement("div");
  head.className = "qhead";
  head.innerHTML = `
    <div>
      <div class="qnum">ç¬¬ ${state.qIndex+1} / ${qs.length} é¢˜</div>
      <p class="qtitle">${q.stem}</p>
    </div>
    <div class="qmeta">
      <div class="qtype">é¢˜å‹ï¼š${typeName(q.type)}</div>
      <div class="tag">${q.type==="multi" ? "ä¸‹ä¸€æ­¥åˆ¤å®š" : "å³æ—¶åé¦ˆ"}</div>
    </div>
  `;
  qArea.appendChild(head);

  if(q.type==="single" || q.type==="multi"){
    const opts = document.createElement("div");
    opts.className = "options";
    const saved = state.answers[q.id] || [];
    q.options.forEach((text, idx)=>{
      const op = document.createElement("div");
      op.className = "opt";
      if(saved.includes(idx)) op.classList.add("selected");
      op.innerHTML = `<div class="mark">${String.fromCharCode(65+idx)}</div><div>${escapeHtml(text)}</div>`;

      op.onclick = ()=>{
        if(q.type==="single"){
          state.answers[q.id] = [idx];
          [...opts.children].forEach(c=>c.classList.remove("selected"));
          op.classList.add("selected");
          judgeObjectiveNow(q); // å•é€‰ä»å³æ—¶åˆ¤ï¼ˆä½ å¯ä»¥æ”¹æˆä¸‹ä¸€æ­¥åˆ¤ï¼‰
        }else{
          // âœ… å¤šé€‰ï¼šåªé€‰ï¼Œä¸åˆ¤
          const cur = new Set(state.answers[q.id] || []);
          if(cur.has(idx)) cur.delete(idx);
          else cur.add(idx);
          state.answers[q.id] = [...cur].sort((a,b)=>a-b);
          op.classList.toggle("selected");
          setFeedback("warn","å·²é€‰æ‹©","å¤šé€‰é¢˜å°†åœ¨ç‚¹å‡»â€œä¸‹ä¸€é¢˜/ä¸‹ä¸€å…³â€æ—¶åˆ¤å®šå¹¶ç»™å‡ºè§£æã€‚");
        }
      };
      opts.appendChild(op);
    });
    qArea.appendChild(opts);

    const fb = makeFeedbackBox();
    qArea.appendChild(fb);

    qActions.appendChild(makeNavButtons(levelId, q));

    if(q.type==="single" && saved.length){
      judgeObjectiveNow(q, true);
    }
  }

  else if(q.type==="pair"){
    state.pairTemp = {left:null, right:null};
    state.pairMap[q.id] = state.pairMap[q.id] || {};

    const pair = document.createElement("div");
    pair.className = "pairwrap";

    const left = document.createElement("div");
    left.className = "paircol";
    left.innerHTML = `<h3>å·¦ä¾§ï¼šè‰²å</h3>`;
    const right = document.createElement("div");
    right.className = "paircol";
    right.innerHTML = `<h3>å³ä¾§ï¼šé€‰é¡¹</h3>`;

    q.left.forEach(item=>{
      const div = document.createElement("div");
      div.className = "pairitem";
      div.dataset.side="L";
      div.dataset.key=item.k;
      div.innerHTML = `<b>${item.k}</b><span class="small">${escapeHtml(item.v)}</span>`;
      div.onclick = ()=>pickPair(q, div);
      left.appendChild(div);
    });

    q.right.forEach(item=>{
      const div = document.createElement("div");
      div.className = "pairitem";
      div.dataset.side="R";
      div.dataset.key=item.k;
      div.innerHTML = `<b>${item.k}</b><span class="small">${escapeHtml(item.v)}</span>`;
      div.onclick = ()=>pickPair(q, div);
      right.appendChild(div);
    });

    pair.appendChild(left); pair.appendChild(right);
    qArea.appendChild(pair);

    const fb = makeFeedbackBox();
    qArea.appendChild(fb);

    qActions.appendChild(makeNavButtons(levelId, q));

    setTimeout(()=>refreshPairUI(q),0);
  }

  else if(q.type==="express"){
    const box = document.createElement("div");
    box.className = "qbox";

    const tips = q.tips.map(t=>`<li>${t}</li>`).join("");
    box.innerHTML = `
      <div class="tag">è¡¨è¾¾é¢˜ Â· ä¸åˆ¤å¯¹é”™</div>
      <p class="muted" style="margin-top:8px">æ¸©é¦¨æé†’ï¼šè¡¨è¾¾é¢˜åªç»™å†™ä½œæ–¹å‘ã€‚å®Œæˆåå³å¯è¿›å…¥ç»“ç®—é¡µã€‚</p>
      <div class="divider"></div>
      <h2>è¦ç‚¹æç¤º</h2>
      <ul style="margin:8px 0 0; color:var(--muted); line-height:1.8; padding-left:20px">${tips}</ul>

      <div class="divider"></div>
      <h2>å†™ä½œåŒºï¼ˆ60â€”120å­—ï¼‰</h2>
      <textarea id="txtExpress" placeholder="ç¤ºä¾‹ï¼šæœˆç™½çš„å…‰åƒè–„é›¾ï¼Œè½»è½»è½åœ¨çª—æ²¿â€¦â€¦"></textarea>
      <div id="expHint" class="feedback show" style="display:block">
        <div class="fbline">
          <div class="fbicon warn">âœ</div>
          <div>
            <p class="fbtitle">å†™ä½œæç¤º</p>
            <p class="fbtext" id="expText">æœªå¡«å†™ã€‚å»ºè®®å†™æ»¡ 60â€”120 å­—ï¼Œå¹¶è‡³å°‘ç”¨ä¸€ä¸ªä¼ ç»Ÿè‰²åã€‚</p>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <h2>è‰²å¡è¯åº“ï¼ˆç‚¹å¼€å·è½´å–å¥å¼ï¼‰</h2>
      <div class="palette" id="paletteExpress"></div>
    `;
    qArea.appendChild(box);

    const fb = makeFeedbackBox();
    qArea.appendChild(fb);

    qActions.appendChild(makeNavButtons(levelId, q, true));

    setTimeout(()=>{
      renderPalette($("paletteExpress"));
      const ta = $("txtExpress");
      ta.value = (state.answers[q.id]||"");
      ta.addEventListener("input", ()=>{
        state.answers[q.id] = ta.value;
        liveExpressHint(ta.value);
      });
      liveExpressHint(ta.value);
    },0);
  }
}

/* ===========================
   10) åé¦ˆæ¡
=========================== */
function makeFeedbackBox(){
  const fb = document.createElement("div");
  fb.className = "feedback";
  fb.id = "fb";
  fb.innerHTML = `
    <div class="fbline">
      <div class="fbicon warn" id="fbIcon">âš </div>
      <div>
        <p class="fbtitle" id="fbTitle">ç­‰å¾…ä½œç­”</p>
        <p class="fbtext" id="fbText">è¯·é€‰æ‹©/å®Œæˆåä¼šå‡ºç°åé¦ˆä¸è§£æã€‚</p>
      </div>
    </div>
  `;
  return fb;
}
function setFeedback(type, title, text){
  const fb = $("fb");
  if(!fb) return;
  fb.classList.add("show");
  const icon = $("fbIcon");
  icon.className = "fbicon " + (type==="ok"?"ok": type==="no"?"no":"warn");
  icon.textContent = type==="ok"?"âœ…": type==="no"?"âŒ":"âš ";
  $("fbTitle").textContent = title;
  $("fbText").innerHTML = text;
}

/* ===========================
   11) å•é€‰å³æ—¶åˆ¤å®šï¼ˆä½ ä¹Ÿå¯æ”¹æˆä¸‹ä¸€æ­¥åˆ¤ï¼‰
=========================== */
function judgeObjectiveNow(q, silent=false){
  const selected = state.answers[q.id] || [];
  if(!selected.length){
    setFeedback("warn","æœªä½œç­”","è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé€‰é¡¹ã€‚");
    return;
  }
  const correct = selected[0]===q.answer[0];
  markSingleUI(correct, q.answer[0], selected[0]);
  if(correct) setFeedback("ok","æ­£ç¡®","<b>è§£æï¼š</b>"+q.explain);
  else setFeedback("no","é”™è¯¯","<b>è§£æï¼š</b>"+q.explain);

  // âœ… è®¡å…¥æ­£ç¡®ç‡ï¼šåªç®—ä¸€æ¬¡
  if(!state.judged[q.id]){
    state.judged[q.id]=true;
    state.doneObjective += 1;
    if(correct) state.correctCount += 1;
    else state.wrongCount += 1;
    updateTopProgress();
  }
}

function markSingleUI(correct, rightIdx, selIdx){
  const opts = document.querySelectorAll(".options .opt");
  opts.forEach((op, idx)=>{
    op.classList.remove("correct","wrong");
    if(selIdx===idx && !correct) op.classList.add("wrong");
    if(rightIdx===idx) op.classList.add("correct");
  });
}

/* ===========================
   12) é…å¯¹é¢˜é€»è¾‘ï¼šå®Œæˆåå³æ—¶åˆ¤ï¼ˆå…è®¸é”™ä¹Ÿèƒ½èµ°ï¼Œä½†ä¼šè®°å½•ï¼‰
=========================== */
function pickPair(q, div){
  const side = div.dataset.side;
  const key = div.dataset.key;

  const curMap = state.pairMap[q.id] || {};
  if(side==="L" && curMap[key]) return;
  if(side==="R" && Object.values(curMap).includes(key)) return;

  if(side==="L") state.pairTemp.left = key;
  else state.pairTemp.right = key;

  refreshPairUI(q);

  if(state.pairTemp.left && state.pairTemp.right){
    curMap[state.pairTemp.left] = state.pairTemp.right;
    state.pairMap[q.id] = curMap;
    state.pairTemp = {left:null, right:null};
    refreshPairUI(q);

    // åˆ¤å®š
    judgePair(q);
  }
}

function refreshPairUI(q){
  const curMap = state.pairMap[q.id] || {};
  document.querySelectorAll(".pairitem").forEach(el=>{
    el.classList.remove("selected","matched");
    const side = el.dataset.side;
    const key = el.dataset.key;
    if(side==="L"){
      if(state.pairTemp.left===key) el.classList.add("selected");
      if(curMap[key]) el.classList.add("matched");
    }else{
      if(state.pairTemp.right===key) el.classList.add("selected");
      if(Object.values(curMap).includes(key)) el.classList.add("matched");
    }
  });
}

function judgePair(q){
  const curMap = state.pairMap[q.id] || {};
  const need = Object.keys(q.answerMap).length;
  const done = Object.keys(curMap).length;

  if(done < need){
    setFeedback("warn","æœªå®Œæˆé…å¯¹",`ä½ å·²é…å¯¹ <b>${done}/${need}</b>ï¼Œè¯·ç»§ç»­å®Œæˆã€‚<br><b>è§£æï¼š</b>${q.explain}`);
    return;
  }
  let ok = true;
  for(const left of Object.keys(q.answerMap)){
    if(curMap[left] !== q.answerMap[left]) ok = false;
  }

  if(ok) setFeedback("ok","é…å¯¹å…¨å¯¹ï¼","<b>è§£æï¼š</b>"+q.explain);
  else setFeedback("no","æœ‰é…å¯¹é”™è¯¯","ä½ å¯ä»¥å¸¦ç€è§£æç»§ç»­å‰è¿›ï¼Œä¹Ÿå¯ä»¥è¿”å›é‡åšã€‚<br><b>è§£æï¼š</b>"+q.explain);

  // âœ… è®¡å…¥æ­£ç¡®ç‡ï¼šåªç®—ä¸€æ¬¡
  if(!state.judged[q.id]){
    state.judged[q.id]=true;
    state.doneObjective += 1;
    if(ok) state.correctCount += 1;
    else state.wrongCount += 1;
    updateTopProgress();
  }
}

/* ===========================
   13) è¡¨è¾¾é¢˜ï¼šå®æ—¶æç¤ºï¼Œä¸åˆ¤å¯¹é”™
=========================== */
function liveExpressHint(text){
  const s = text.trim();
  const len = s.length;
  const hasColor = ["æœˆç™½","é»›é’","èƒ­è„‚","ç„çº","é›¨è¿‡å¤©é’"].some(w=>s.includes(w));
  const hint = $("expText");
  if(!hint) return;

  if(!len){
    hint.innerHTML = "æœªå¡«å†™ã€‚å»ºè®®å†™æ»¡ <b>60â€”120</b> å­—ï¼Œå¹¶è‡³å°‘ç”¨ä¸€ä¸ªä¼ ç»Ÿè‰²åã€‚";
    setFeedback("warn","æœªå®Œæˆ","è¡¨è¾¾é¢˜æœªå¡«å†™ï¼šè¯·å®Œæˆåå†è¿›å…¥ç»“ç®—ã€‚");
    return;
  }
  let msg = `å·²å¡«å†™ <b>${len}</b> å­—ã€‚`;
  if(len < 60) msg += ` å»ºè®®å†è¡¥å……ç”»é¢ç»†èŠ‚ï¼ˆå¦‚å…‰å½±ã€æ°”å‘³ã€å£°éŸ³ï¼‰ï¼Œå†™åˆ° <b>60</b> å­—ä»¥ä¸Šã€‚`;
  else if(len > 120) msg += ` ç•¥é•¿ï¼Œå¯ç²¾ç‚¼ï¼šä¿ç•™â€œè‰²å+æ„è±¡+æƒ…æ„Ÿâ€çš„å…³é”®å¥ã€‚`;
  else msg += ` å­—æ•°åˆé€‚ã€‚`;
  msg += hasColor ? ` <b>âˆš å·²ä½¿ç”¨ä¼ ç»Ÿè‰²å</b>` : ` <b>Ã— å»ºè®®åŠ å…¥è‡³å°‘1ä¸ªä¼ ç»Ÿè‰²å</b>`;
  msg += `<br>å†™ä½œæ–¹å‘ï¼šå…ˆå†™â€œè‰²åçš„æ„Ÿè§‰â€ï¼Œå†å†™â€œå®ƒç…§è§äº†ä»€ä¹ˆâ€ï¼Œæœ€åç‚¹å‡ºâ€œæƒ…æ„Ÿ/æ–‡åŒ–è”æƒ³â€ã€‚`;
  hint.innerHTML = msg;

  setFeedback("warn","è¡¨è¾¾é¢˜æç¤º","è¡¨è¾¾é¢˜ä¸åˆ¤å¯¹é”™ï¼Œä½†éœ€å¡«å†™åæ‰èƒ½ç»“ç®—ã€‚");
}

/* ===========================
   14) ä¸‹ä¸€é¢˜æŒ‰é’®é€»è¾‘ï¼šå¤šé€‰é¢˜â€œä¸‹ä¸€æ­¥åˆ¤å®šâ€ + å…è®¸é”™ä¹Ÿèƒ½èµ°
=========================== */
function makeNavButtons(levelId, q){
  const frag = document.createDocumentFragment();

  const btnPrev = document.createElement("button");
  btnPrev.className = "ghost";
  btnPrev.textContent = "ä¸Šä¸€é¢˜";
  btnPrev.onclick = ()=>{
    if(state.qIndex>0){
      state.qIndex--;
      renderQuestion(levelId);
    }else{
      prevLevel();
    }
  };

  const btnNext = document.createElement("button");
  btnNext.className = "primary";
  btnNext.textContent = (state.qIndex === QUESTIONS[levelId].length-1) ? "è¿›å…¥ä¸‹ä¸€å…³" : "ä¸‹ä¸€é¢˜";

  btnNext.onclick = ()=>{
    // è¡¨è¾¾é¢˜ï¼šå¿…é¡»å¡«å†™æ‰å¯ç»“ç®—
    if(q.type==="express"){
      const text = (state.answers[q.id]||"").trim();
      if(!text.length){
        setFeedback("warn","æœªå®Œæˆ","è¡¨è¾¾é¢˜æœªå¡«å†™ï¼šè¯·å…ˆå†™ä¸€æ®µå†è¿›å…¥ç»“ç®—ã€‚");
        return;
      }
      if(state.doneExpress===0){
        state.doneExpress = 1;
        updateTopProgress();
      }
      if(state.qIndex === QUESTIONS[levelId].length-1) nextLevel();
      else { state.qIndex++; renderQuestion(levelId); }
      return;
    }

    // å•é€‰ï¼šè‹¥æœªåˆ¤è¿‡ï¼Œå…ˆåˆ¤ï¼ˆå³æ—¶åˆ¤ä¹Ÿç®—ä¸€æ¬¡ï¼‰
    if(q.type==="single" && !state.judged[q.id]){
      const sel = state.answers[q.id] || [];
      if(!sel.length){
        setFeedback("warn","æœªä½œç­”","è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé€‰é¡¹å†è¿›å…¥ä¸‹ä¸€é¢˜ã€‚");
        return;
      }
      judgeObjectiveNow(q);
      // å•é€‰å…è®¸å¸¦é”™å‰è¿›ï¼šä¸return
    }

    // âœ… å¤šé€‰ï¼šç‚¹å‡»ä¸‹ä¸€æ­¥æ—¶åˆ¤å®šï¼Œä¸æ‹¦è·¯
    if(q.type==="multi"){
      const sel = state.answers[q.id] || [];
      if(!sel.length){
        setFeedback("warn","æœªä½œç­”","è¯·è‡³å°‘å‹¾é€‰ä¸€ä¸ªé€‰é¡¹å†è¿›å…¥ä¸‹ä¸€é¢˜ã€‚");
        return;
      }

      const ans = new Set(q.answer);
      const set = new Set(sel);
      let ok = true;
      for(const a of ans) if(!set.has(a)) ok=false;
      for(const s of set) if(!ans.has(s)) ok=false;

      // UIæ ‡æ³¨å¯¹é”™ï¼ˆå¯é€‰ï¼šæ˜¾ç¤ºæ­£ç¡®é¡¹ã€é”™è¯¯é¡¹ï¼‰
      markMultiUI(q.answer, sel);

      // è®¡å…¥æ­£ç¡®ç‡ï¼šåªç®—ä¸€æ¬¡
      if(!state.judged[q.id]){
        state.judged[q.id] = true;
        state.doneObjective += 1;
        if(ok) state.correctCount += 1;
        else state.wrongCount += 1;
        updateTopProgress();
      }

      if(ok){
        setFeedback("ok","æ­£ç¡®","<b>è§£æï¼š</b>"+q.explain);
      }else{
        let miss=0, extra=0;
        for(const a of ans) if(!set.has(a)) miss++;
        for(const s of set) if(!ans.has(s)) extra++;
        let tip = (miss && extra) ? "ä½ æœ‰<b>æ¼é€‰</b>ä¹Ÿæœ‰<b>å¤šé€‰</b>ã€‚" : miss ? "ä½ æœ‰<b>æ¼é€‰</b>ã€‚" : "ä½ æœ‰<b>å¤šé€‰</b>ã€‚";
        setFeedback("no","é”™è¯¯", `${tip}<br><b>è§£æï¼š</b>${q.explain}`);
      }
      // âœ… ä¸æ‹¦è·¯ï¼Œç»§ç»­å‰è¿›
    }

    // é…å¯¹ï¼šè‹¥è¿˜æ²¡é…å®Œï¼Œå…è®¸å‰è¿›ä½†æç¤ºï¼ˆä½ ä¹Ÿå¯æ”¹ä¸ºå¿…é¡»é…å®Œï¼‰
    if(q.type==="pair"){
      const curMap = state.pairMap[q.id] || {};
      const need = Object.keys(q.answerMap).length;
      if(Object.keys(curMap).length < need){
        setFeedback("warn","é…å¯¹æœªå®Œæˆ","ä½ è¿˜æ²¡é…å®Œï¼Œä½†å¯ä»¥ç»§ç»­å‰è¿›ã€‚å»ºè®®å›å¤´å®Œæˆä»¥æé«˜æ­£ç¡®ç‡ã€‚");
        // ä¸return
      }else{
        // è‹¥é…å®Œä½†è¿˜æ²¡åˆ¤è¿‡ï¼ˆé€šå¸¸å·²åˆ¤ï¼‰ï¼Œè¿™é‡Œè¡¥ä¸€æ¬¡
        if(!state.judged[q.id]) judgePair(q);
      }
    }

    // å‰è¿›
    if(state.qIndex === QUESTIONS[levelId].length-1) nextLevel();
    else { state.qIndex++; renderQuestion(levelId); }
  };

  frag.appendChild(btnPrev);
  frag.appendChild(btnNext);
  return frag;
}

function markMultiUI(answer, selected){
  const opts = document.querySelectorAll(".options .opt");
  const ans = new Set(answer);
  const sel = new Set(selected);
  opts.forEach((op, idx)=>{
    op.classList.remove("correct","wrong");
    if(ans.has(idx)) op.classList.add("correct");
    if(sel.has(idx) && !ans.has(idx)) op.classList.add("wrong");
  });
}

/* ===========================
   15) å…³å¡åˆ‡æ¢
=========================== */
function nextLevel(){
  if(state.levelIndex < LEVELS.length-1){
    state.levelIndex++;
    state.qIndex = 0;
    render();
  }
}
function prevLevel(){
  if(state.levelIndex>0){
    state.levelIndex--;
    state.qIndex = 0;
    render();
  }
}

/* ===========================
   16) ç»“ç®—é¡µï¼šæ­£ç¡®ç‡ + ç”¨æ—¶ ç»¼åˆè¯„åˆ†
=========================== */
function renderResult(){
  const wrap = document.createElement("div");

  // ç”¨æ—¶
  state.usedSeconds = Math.round((Date.now() - state.startTime)/1000);

  const accuracy = state.totalObjective ? (state.correctCount / state.totalObjective) : 0;
  const complete = getCompletion();

  // æ—¶é—´åˆ†ï¼š10åˆ†é’Ÿï¼ˆ600ç§’ï¼‰ä¸ºæ ‡å‡†ï¼›è¶Šå¿«è¶Šé«˜ï¼ˆ0~1ï¼‰
  const timeScore = clamp(1 - state.usedSeconds / 600, 0, 1);

  // ç»¼åˆåˆ†ï¼šæ­£ç¡®ç‡70% + é€Ÿåº¦30%
  state.score = Math.round(accuracy*70 + timeScore*30);

  const advice = makeAdvice(accuracy, timeScore, complete);

  wrap.innerHTML = `
    <div class="tag">ç»“ç®—é¡µ Â· ä½ çš„å­¦ä¹ å›å£°</div>
    <h1>é—¯å…³å®Œæˆï¼æ„¿ä½ æŠŠä¸­å›½è‰²å†™è¿›è‡ªå·±çš„è¯­è¨€</h1>
    <p>æˆç»©æŒ‰ç…§ <b>æ­£ç¡®ç‡ + ç”¨æ—¶</b> ç»¼åˆè¯„åˆ†ï¼ˆ0â€”100ï¼‰ã€‚è¡¨è¾¾é¢˜ä¸åˆ¤å¯¹é”™ï¼Œä½†è®¡å®Œæˆåº¦ã€‚</p>

    <div class="divider"></div>

    <div class="grid" style="grid-template-columns:1fr 1fr; gap:14px">
      <div class="card" style="box-shadow:none">
        <h2>ç»¼åˆè¯„åˆ†</h2>
        <p style="font-size:34px;margin:6px 0 0;font-weight:900;color:var(--ink)">${state.score}<span style="font-size:14px;color:var(--muted)"> / 100</span></p>
        <p class="muted">æ­£ç¡®ç‡ï¼š${Math.round(accuracy*100)}% ï½œ ç”¨æ—¶ï¼š${fmtTime(state.usedSeconds)}</p>
      </div>
      <div class="card" style="box-shadow:none">
        <h2>å®Œæˆåº¦</h2>
        <p style="font-size:34px;margin:6px 0 0;font-weight:900;color:var(--ink)">${complete}<span style="font-size:14px;color:var(--muted)"> %</span></p>
        <p class="muted">å®Œæˆåº¦ = å®¢è§‚é¢˜åˆ¤å®šæ•° + è¡¨è¾¾é¢˜å®Œæˆã€‚</p>
      </div>
    </div>

    <div class="divider"></div>

    <h2>å­¦ä¹ å»ºè®®</h2>
    <div class="feedback show" style="display:block">
      <div class="fbline">
        <div class="fbicon ok">âœ¨</div>
        <div>
          <p class="fbtitle">ç»™ä½ çš„å»ºè®®</p>
          <p class="fbtext">${advice}</p>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <h2>æŠŠæˆç»©å†™å…¥æ’è¡Œæ¦œ</h2>
    <p>å°†ä»¥ä½ å¡«å†™çš„ä¿¡æ¯å†™å…¥æœ¬æœºæ’è¡Œæ¦œï¼ˆç¦»çº¿ä¿å­˜ï¼‰ã€‚</p>
    <div class="btnrow">
      <button class="primary" id="btnSaveRank">ä¿å­˜åˆ°æ’è¡Œæ¦œ</button>
      <button class="ghost" id="btnRestart">å†é—¯ä¸€æ¬¡</button>
    </div>

    <div class="footnote">
      <b>æ¸©é¦¨æé†’ï¼š</b>å»ºè®®ä½ æŠŠè¡¨è¾¾é¢˜ä¸­çš„å¥å­å†æ¶¦è‰²ä¸€æ¬¡ï¼šåŠ å…¥â€œæ„è±¡ç»†èŠ‚ + æƒ…æ„Ÿç‚¹é¢˜â€ï¼Œè®©æ–‡å­—æ›´æœ‰â€œåä¸­æœ‰ç”»ã€è‰²ä¸­æœ‰æƒ…â€ã€‚<br>
      å¦‚éœ€çµæ„Ÿï¼Œéšæ—¶ç‚¹å¼€å³ä¾§è‰²å¡å·è½´å–å¥å¼ä¸å…³é”®è¯ã€‚
    </div>
  `;

  setTimeout(()=>{
    $("btnSaveRank").onclick = ()=>{
      const entry = {
        name: state.user.name || "åŒ¿ååŒå­¦",
        cls: state.user.cls || "ä¹å¹´çº§",
        score: state.score,
        accuracy: Math.round(accuracy*100),
        seconds: state.usedSeconds,
        complete: getCompletion(),
        time: Date.now()
      };
      addRankEntry(entry);
      renderRank();
      alert("å·²ä¿å­˜åˆ°æ’è¡Œæ¦œï¼");
    };
    $("btnRestart").onclick = ()=>{
      if(confirm("ç¡®å®šé‡æ–°é—¯å…³ï¼Ÿï¼ˆå½“å‰ç­”é¢˜è®°å½•å°†æ¸…ç©ºï¼‰")){
        resetAll();
      }
    };
  },0);

  return wrap;
}

function makeAdvice(accuracy, timeScore, complete){
  if(complete < 100){
    return `ä½ è¿˜æœ‰å†…å®¹æœªå®Œæˆã€‚å»ºè®®æŠŠè¡¨è¾¾é¢˜å†™æ»¡ 60â€”120 å­—ï¼Œå¹¶è‡³å°‘ä½¿ç”¨ 1 ä¸ªä¼ ç»Ÿè‰²åã€‚å†™ä½œæ—¶å¯æ‰“å¼€è‰²å¡å·è½´ï¼Œå€ŸåŠ©â€œæ„è±¡å…³é”®è¯ + å¥å¼ç¤ºèŒƒâ€å®Œå–„è¯­è¨€ã€‚`;
  }
  if(accuracy >= .9 && timeScore >= .6){
    return `å¤ªæ£’äº†ï¼ä½ ä¸ä»…ç†è§£å‡†ç¡®ï¼Œè€Œä¸”å®Œæˆé€Ÿåº¦å¾ˆå¿«ã€‚å»ºè®®ä¸‹ä¸€æ­¥ï¼šåœ¨è¯—è¯é‰´èµæ—¶ä¸»åŠ¨æ›¿æ¢â€œç°ä»£é¢œè‰²è¯â€ï¼Œç”¨â€œæœˆç™½ã€é»›é’ã€èƒ­è„‚ã€ç„çºâ€ç­‰è¿›è¡Œèµæè¡¨è¾¾ï¼Œè®©è¯­è¨€æ›´å…·ç”»é¢ä¸æ–‡åŒ–æ¸©åº¦ã€‚`;
  }
  if(accuracy >= .7){
    return `ä½ çš„ç†è§£æ¯”è¾ƒæ‰å®ã€‚å»ºè®®å›çœ‹è§£æï¼Œé‡ç‚¹å·©å›ºä¸¤æ¡é€»è¾‘ï¼šâ‘ â€œåä¸­æœ‰ç”»ï¼ˆæ¥æºï¼‰â€ï¼›â‘¡â€œè‰²ä¸­æœ‰æƒ…ï¼ˆæ„å¢ƒ/æƒ…æ„Ÿï¼‰â€ã€‚å†™ä½œæ—¶å¤šç”¨â€œæºäºâ€¦/è¥é€ â€¦â€å¥å¼ï¼Œè¡¨è¾¾ä¼šæ›´ç²¾å‡†ã€‚`;
  }
  return `åˆ«æ€¥ï¼Œå­¦ä¹ ä¸­å›½è‰²éœ€è¦â€œçœ‹è§+è¯´å‡ºâ€ã€‚å»ºè®®ä½ æŠŠé”™é¢˜å¯¹åº”çš„è‰²å¡å†æ‰“å¼€å·è½´è¯»ä¸€éï¼šè®°ä½â€œæ¥æºâ€”æ„è±¡â€”å¥å¼â€ï¼Œå†å›åˆ°é¢˜ç›®å°±æ›´å®¹æ˜“ç­”å¯¹ã€‚ä¹Ÿå¯ä»¥æŠŠè¡¨è¾¾é¢˜å†™å¾—æ›´å…·ä½“ï¼šåŠ ä¸Šâ€œå…‰å½±/å£°éŸ³/æ°”å‘³â€ç­‰ç»†èŠ‚ã€‚`;
}

function resetAll(){
  state.levelIndex=0;
  state.qIndex=0;

  state.startTime=0;
  state.usedSeconds=0;

  state.correctCount=0;
  state.wrongCount=0;
  state.judged={};

  state.doneObjective=0;
  state.doneExpress=0;

  state.answers={};
  state.pairTemp={left:null,right:null};
  state.pairMap={};

  state.score=0;
  render();
}

/* ===========================
   17) å·¥å…·
=========================== */
function typeName(t){
  return t==="single"?"å•é€‰é¢˜":t==="multi"?"å¤šé€‰é¢˜":t==="pair"?"é…å¯¹é¢˜":"è¡¨è¾¾é¢˜";
}
function escapeHtml(str){
  return (str||"").replace(/[&<>"']/g, s=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[s]));
}
function fmtTime(sec){
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}åˆ†${String(s).padStart(2,"0")}ç§’`;
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
</script>
</body>
</html>
